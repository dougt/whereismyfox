<html>
  <head>
    <title>WhereIsMyFox</title>

    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="https://login.persona.org/include.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

    <script>
      function unregister(pushURL) {
        $.ajax({
              type: 'GET',
              url: '/device/delete/',
              data: {pushURL: pushURL},
              success: function(res, status, xhr) {
                updateDevices();
              },
              error: function(xhr, status, err) {
              }
          });
      }

      function whereIsIt(pushURL) {
        $.ajax({
          type: 'POST',
          url: '/device/lost/',
          data: {pushURL: pushURL},
          error: function(xhr, status, err) {
            console.log("PUT failed: " + err);
          }
        });
      }

      function updateDevices() {
        $("#devices").html("<div> Fetching list.. </div>");
        $.ajax({
              type: 'GET',
              url: '/device/list',
              success: function(r) {

              $("#devices").html("");

               var result = JSON.parse(r)
               $.each(result.Devices, function(key, value){
                   $("#devices").append("<div class='devices'>" + value.DeviceName);
                   $("#devices").append("<button type='button' onClick='unregister(\"" + value.PushURL + "\")''>Unregister</button>");
                   $("#devices").append("<button type='button' onClick='whereIsIt(\"" + value.PushURL + "\");'>Where is it?</button>");
                   $("#devices").append("</div>");
               });

            },
            error: function(xhr, status, err) {
              $("#devices").html("<div> </div>");
            }
          });
      }

      $("document").ready(function(){

          $("#logout").hide();
          $("#devices").hide();

          function loggedIn(email){
            $("#login").hide();
            $("#logout").show();

            $("#devices").show();
            updateDevices();
          }

          function loggedOut(){
            $("#logout").hide();
            $("#login").show();
            $("#devices").hide();
          }

          $("#login").on("click", function(e) {
              e.preventDefault();
              navigator.id.get(mailVerified);
          });

          $("#logout").on("click", function(e) {
              e.preventDefault();
              $.get('/auth/logout', loggedOut);
          });

          function mailVerified(assertion){
            $.ajax({
                type: 'POST',
                  url: '/auth/login',
                  data: {assertion: assertion},
                  success: function(res, status, xhr) {
                  loggedIn(JSON.parse(res).email);
                },
                  error: function(xhr, status, err) {
                  alert("Login failure: " + err);
                }
              });
          }

          $.get('/auth/check', function (res) {
              if (res === "") {
                loggedOut();
              } else {
                loggedIn(res);
              }
          });
    });

    </script>
  </head>

  <body>
    <h1 id="title">Where Is My Fox?</h1>
    <div>
        <button id="login">login</button>
        <button id="logout">logout</button>
    </div>
    <div id="devices">
    </div>

  </body>
</html>
